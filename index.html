<!doctype html>

<html lang="fi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Keulinta Ultimate — Piirretty 2D mopo-peli (Pro)</title>
<style>
  :root{--bg1:#0ea;--bg2:#7ef}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#87ceeb,#a0d8ff);font-family:Inter,system-ui,Arial,sans-serif;color:#012}
  .wrap{display:flex;flex-direction:column;height:100%}
  header{padding:8px;text-align:center}
  #game{display:block;margin:0 auto;border-radius:10px;box-shadow:0 18px 46px rgba(0,0,0,0.28);background:linear-gradient(#87ceeb,#a0d8ff)}
  .hud{display:flex;gap:10px;justify-content:space-between;padding:8px 16px;align-items:center}
  .panel{background:rgba(255,255,255,0.9);padding:8px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
  .controls{display:flex;gap:8px}
  button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0;background:#046;color:#fff}
  .select{padding:8px;border-radius:8px}
  .small{font-size:12px}
  #overlay{position:fixed;left:12px;bottom:12px}
  .toast{background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border-radius:8px;margin-top:6px}
  @media (max-width:800px){#game{width:95vw;height:56vh}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Keulinta Ultimate — Piirretty Mopo (Pro)</h1>
    <div class="hud">
      <div class="panel small" id="infoPanel">A = Kaasu · S = Jarru · ←/→ ilmassa</div>
      <div class="panel controls">
        <select id="bikeSelect" class="select"></select>
        <select id="trackSelect" class="select"></select>
        <button id="shopBtn">Päivitykset</button>
        <button id="recordBtn">Tallenna toisto</button>
        <button id="resetBtn">Reset</button>
      </div>
    </div>
  </header>
  <canvas id="game" width="1280" height="720"></canvas>
  <div id="overlay"></div>
</div>
<script>
// Keulinta Ultimate - feature-rich demo
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const overlay = document.getElementById('overlay');// Utilities const clamp = (v,a,b) => Math.max(a, Math.min(b, v)); const lerp = (a,b,t) => a + (b-a)t; const rand = (a,b) => a + Math.random()(b-a);

// Audio (simple synth fx + SFX loader fallback) const AudioCtx = window.AudioContext || window.webkitAudioContext; const audio = AudioCtx ? new AudioCtx() : null; function sfxBeep(freq,dur=0.08, type='sine', gain=0.12){ if(!audio) return; const o=audio.createOscillator(); const g=audio.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audio.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + dur); o.stop(audio.currentTime + dur); }

// Particle system const particles = []; function spawnParticle(x,y,dx,dy,life=0.6,size=4){ particles.push({x,y.dx:dx,dy:dy,life,age:0,size,ax:dx0.0,ay:160}) } function updateParticles(dt){ for(let i=particles.length-1;i>=0;i--){const p=particles[i]; p.age+=dt; if(p.age>p.life){particles.splice(i,1); continue;} p.x+=p.dxdt; p.y+=p.dydt; p.dy+=p.aydt; }} function drawParticles(ctx){ for(const p of particles){ const t = p.age / p.life; ctx.globalAlpha = 1 - t; ctx.fillStyle = 'rgba(50,40,40,0.85)'; ctx.beginPath(); ctx.arc(p.x,p.y, p.size*(1-t), 0, Math.PI*2); ctx.fill(); } ctx.globalAlpha = 1; }

// Bikes and tracks const BIKES = [ {id:'moped',name:'Classic Mopo',mass:75, wheelBase:130, rearR:30, frontR:26, maxTorque:520, gear:2.6, cog:-18, suspension:0.25, grip:1.05, color:'#ffd54f'}, {id:'sport',name:'Sport 125',mass:95, wheelBase:150, rearR:28, frontR:24, maxTorque:980, gear:4.0, cog:-12, suspension:0.14, grip:0.98, color:'#ff4d4d'}, {id:'off',name:'Offroad',mass:105, wheelBase:145, rearR:34, frontR:30, maxTorque:820, gear:3.4, cog:-16, suspension:0.36, grip:1.15, color:'#66e07e'}, {id:'custom',name:'Boosted Pro',mass:88, wheelBase:138, rearR:30, frontR:26, maxTorque:1100, gear:4.6, cog:-8, suspension:0.12, grip:0.9, color:'#6ec6ff', special:'nitro'} ]; const TRACKS = [ {id:'city',name:'Kaupunkirata',length:4000, obstacles: true}, {id:'ramp',name:'Ratahypyt',length:3000, obstacles:true}, {id:'open',name:'Avoin Maantie',length:6000, obstacles:false} ];

const bikeSelect = document.getElementById('bikeSelect'); BIKES.forEach((b,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=b.name; bikeSelect.appendChild(o)}); const trackSelect = document.getElementById('trackSelect'); TRACKS.forEach((t,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=t.name; trackSelect.appendChild(o)});

// Game state const state = { bike: JSON.parse(JSON.stringify(BIKES[0])), track: TRACKS[0], x: 180, y: 430, velX:120, velY:0, angle:0, angVel:0, wheelRearAng:0, wheelFrontAng:0, throttle:0, brake:0, nitro:0, nitroBoost:0, score:0, best: parseInt(localStorage.getItem('keulinta_best')||'0',10), combo:0, combosBest: parseInt(localStorage.getItem('keulinta_combo')||'0',10), achievements: {}, replayRecording: false, replayBuffer: [], ghostBuffer: JSON.parse(localStorage.getItem('keulinta_ghost')||'null') || null, settings: {quality:'high',sound:true,particles:true}, shop:{coins: parseInt(localStorage.getItem('keulinta_coins')||'0',10), upgrades:{}}, paused:false };

// Input const input = {gas:false,brake:false,left:false,right:false,nitro:false}; window.addEventListener('keydown', e=>{const k=e.key.toLowerCase(); if(k==='a') input.gas=true; if(k==='s') input.brake=true; if(k==='arrowleft') input.left=true; if(k==='arrowright') input.right=true; if(k===' ') input.nitro=true;}); window.addEventListener('keyup', e=>{const k=e.key.toLowerCase(); if(k==='a') input.gas=false; if(k==='s') input.brake=false; if(k==='arrowleft') input.left=false; if(k==='arrowright') input.right=false; if(k===' ') input.nitro=false;});

// Touch and UI function toast(text, time=2500){ const t=document.createElement('div'); t.className='toast'; t.textContent=text; overlay.appendChild(t); setTimeout(()=>{t.remove()}, time); } document.getElementById('shopBtn').addEventListener('click', ()=> openShop()); document.getElementById('recordBtn').addEventListener('click', ()=>{ state.replayRecording = !state.replayRecording; document.getElementById('recordBtn').textContent = state.replayRecording ? 'Pysäytä tall.' : 'Tallenna toisto'; if(!state.replayRecording){ localStorage.setItem('keulinta_ghost', JSON.stringify(state.replayBuffer)); state.ghostBuffer = state.replayBuffer; toast('Toisto tallennettu'); state.replayBuffer = []; } else { state.replayBuffer = []; toast('Tallennus käynnissä'); } }); document.getElementById('resetBtn').addEventListener('click', ()=> reset());

bikeSelect.addEventListener('change', ()=>{ reset(); state.bike = JSON.parse(JSON.stringify(BIKES[bikeSelect.value])); toast('Valittu: '+state.bike.name); }); trackSelect.addEventListener('change', ()=>{ state.track = TRACKS[trackSelect.value]; reset(); });

// Save/load shop & upgrades function saveState(){ localStorage.setItem('keulinta_shop', JSON.stringify(state.shop)); localStorage.setItem('keulinta_best', String(state.best)); } setInterval(saveState, 2000);

// Reset function reset(){ state.x = 180; state.y = 430; state.velX = 80; state.velY = 0; state.angle = 0; state.angVel = 0; state.wheelRearAng = 0; state.wheelFrontAng=0; state.score = 0; state.combo = 0; } reset();

// Physics helpers: torque curve, suspension, grip function torqueCurve(bike, throttle){ const t = throttle; const peak = bike.maxTorque * (1 + (state.shop.upgrades.torque||0)0.1); const curve = t * (1 - Math.pow(t-0.55,2)); return clamp(curvepeak,0,peak); }

function step(dt){ // smoothing inputs state.throttle = lerp(state.throttle, input.gas ? 1 : 0, 8dt); state.brake = lerp(state.brake, input.brake ? 1 : 0, 12dt);

// nitro
if(input.nitro && state.bike.special === 'nitro' && state.nitro < 3){ state.nitro += 6*dt; state.nitroBoost = lerp(state.nitroBoost, 1.6, 6*dt);} else { state.nitro = Math.max(0, state.nitro - 0.5*dt); state.nitroBoost = lerp(state.nitroBoost, 1, 2*dt); }

// longitudinal forces
const tforce = torqueCurve(state.bike, state.throttle) * state.bike.gear;
const wheelR = (state.bike.rearR + state.bike.frontR) * 0.45;
const drive = tforce / Math.max(1, wheelR) * (1 + state.nitroBoost - 1);

// resistances
const drag = 0.00045 * state.velX * state.velX * (1 + (state.bike.mass-80)/180);
const rolling = 12 + state.bike.mass*0.015;
let acc = (drive - drag - rolling * Math.sign(state.velX)) / state.bike.mass;

state.velX += acc * dt * 60;
if(state.brake) state.velX -= 1200 * state.brake * dt;
state.velX = clamp(state.velX, 0, 1200);

// angular dynamics -> wheelie
const cog = state.bike.cog + (state.throttle - state.brake)*6; // dynamic COG shift
const lever = Math.max(12, Math.abs(cog) + 0.5*state.bike.wheelBase*Math.sin(state.angle));
const lift = tforce * lever * 0.0009;
const gravTorque = state.bike.mass * 9.81 * Math.sin(state.angle) * 0.12;

let angAcc = (lift - gravTorque) / (80 + state.bike.mass*0.24) - state.angVel*(0.45 + 0.0015*state.velX);
if(state.brake) angAcc -= 5.5 * state.brake;
state.angVel += angAcc * dt * 60;
state.angle += state.angVel * dt * 60;
state.angle = clamp(state.angle, -Math.PI/2, Math.PI/1.6);

// vertical/suspension
const groundY = 430;
const springK = 1500 * (state.bike.suspension*4);
const damping = 90;
const defl = state.y - groundY;
const springAcc = (-springK*defl - damping*state.velY) / state.bike.mass;
state.velY += springAcc * dt;
state.y += state.velY * dt * 60;
if(state.y > groundY){ if(Math.abs(state.angVel) > 0.6) state.angVel *= 0.45; state.y = groundY; state.velY = 0; }

// grip & slip
const slip = Math.abs(state.angVel) * 0.35 + Math.max(0, state.throttle*1.8 - 1.2);
const grip = state.bike.grip * (1 - clamp(slip,0,0.9));
state.velX *= (1 - (0.002*(1 - grip)));

// particles on wheels
if(state.settings.particles && (state.throttle > 0.2) && state.velX>60){ for(let i=0;i<2;i++){ particles.push({x:state.x + (Math.random()*40-20), y:state.y + 18 + Math.random()*6, dx: -50 + Math.random()*100, dy: -40 - Math.random()*40, life:0.6 + Math.random()*0.6, size: 3+Math.random()*3}); } }

// score & combos
if(state.angle > 0.42 && state.velX > 80){ state.combo += dt; state.score += dt * state.velX * (1 + state.throttle); } else { if(state.combo > 0.8){ state.shop.coins += Math.floor(state.combo*2); toast('Combo! +' + Math.floor(state.combo*2) + ' kolikkoa'); state.combosBest = Math.max(state.combosBest, Math.floor(state.combo)); localStorage.setItem('keulinta_combo', String(state.combosBest)); } state.combo = 0; state.score *= 0.9996; }
state.best = Math.max(state.best, Math.floor(state.score));

// wheel rotation
state.wheelRearAng += state.velX / (state.bike.rearR*0.5) * dt;
state.wheelFrontAng += state.velX / (state.bike.frontR*0.5) * dt;

// replay recording
if(state.replayRecording){ state.replayBuffer.push({t:Date.now(), x:state.x, y:state.y, velX:state.velX, angle:state.angle, angVel:state.angVel}); if(state.replayBuffer.length>20000) state.replayBuffer.shift(); }

// achievements simple
if(state.velX > 500 && !state.achievements['speed500']){ state.achievements['speed500']=true; toast('Achievement: Nopeus 500+!'); }
if(state.combo > 5 && !state.achievements['combo5']){ state.achievements['combo5']=true; toast('Achievement: Combo 5s!'); }

// simple world wrap
state.x += state.velX * dt;
if(state.x > state.track.length) state.x -= state.track.length;

// particle update
for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.age = (p.age||0) + dt; if(p.age>p.life) particles.splice(i,1); else { p.x += p.dx*dt; p.y += p.dy*dt; p.dy += 220*dt; } }

}

// Rendering function draw(){ ctx.clearRect(0,0,W,H); // background gradient const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#87ceeb'); g.addColorStop(1,'#a0d8ff'); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

// sun & clouds
ctx.fillStyle='rgba(255,240,180,0.9)'; ctx.beginPath(); ctx.arc(W-140,80,42,0,Math.PI*2); ctx.fill();
ctx.fillStyle='rgba(255,255,255,0.85)'; for(let i=0;i<4;i++){ ctx.beginPath(); ctx.ellipse(120 + i*220 - (state.x*0.02)%W, 80 + Math.sin(i+state.x*0.001)*8, 48, 22, 0,0,Math.PI*2); ctx.fill(); }

// parallax hills
for(let layer=0; layer<3; layer++){ ctx.fillStyle = ['#6bbf4a','#4aa34a','#297a2b'][layer]; ctx.beginPath(); const offset = (state.x * 0.06 * (layer+1))%W; ctx.moveTo(-W, H-200-layer*18); for(let x=-W; x<=W*2; x+=40){ ctx.quadraticCurveTo(x+20+offset, H-260 - layer*18*Math.sin((x+offset)/200), x+40, H-200 - layer*18); } ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.fill(); }

// road
ctx.fillStyle='#2f2f2f'; ctx.fillRect(0,430,W,160);
for(let i=0;i<200;i++){ const stripeW=36, gap=56; const x = (i*(stripeW+gap) - (state.x % (stripeW+gap))); ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(x,462,stripeW,6); }

// obstacles & ramps (procedural predictable)
drawRampsAndObstacles();

// ghost playback
if(state.ghostBuffer && state.ghostBuffer.length>10){ const idx = Math.floor((Date.now()/80) % state.ghostBuffer.length); const gS = state.ghostBuffer[idx]; if(gS) drawGhost(gS); }

// particles
for(const p of particles){ const t = (p.age||0)/p.life; ctx.globalAlpha = 1-t; ctx.fillStyle='rgba(60,50,40,0.9)'; ctx.beginPath(); ctx.arc(p.x - (state.x%W), p.y, p.size*(1-t), 0, Math.PI*2); ctx.fill(); } ctx.globalAlpha = 1;

// draw player's bike centered horizontally
drawBike(ctx, W*0.4, state.y - 0, -state.angle, state.bike, state);

// NPCs for visual
for(let i=1;i<5;i++){ const ox = (W*0.4 - 200 + i*240 - (state.x*0.3)%800); const oy = 430 + (i%2?6:-6); drawBike(ctx, ox, oy, -0.08 + 0.02*i, BIKES[(i)%BIKES.length], {}); }

// HUD
ctx.fillStyle='rgba(255,255,255,0.92)'; ctx.fillRect(10,10,300,110); ctx.fillStyle='#012'; ctx.font='16px sans-serif'; ctx.fillText('Nopeus: '+Math.round(state.velX)+' px/s', 22,34); ctx.fillText('Pisteet: '+Math.floor(state.score),22,58); ctx.fillText('Paras: '+state.best,22,82); ctx.fillText('Kolikot: '+state.shop.coins,22,106);

// Nitro meter
ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(W-220,12,200,22); ctx.fillStyle='#ffdd00'; ctx.fillRect(W-218,14, clamp(state.nitro/3,0,1)*196,18); ctx.strokeStyle='#012'; ctx.strokeRect(W-220,12,200,22);

// combo meter and achievements
if(state.combo>0.3){ ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(W/2-120,12,240,26); ctx.fillStyle='#c33'; ctx.fillRect(W/2-118,14, clamp(state.combo/6,0,1)*236,22); ctx.fillStyle='#012'; ctx.fillText('Combo: '+Math.floor(state.combo)+'s', W/2-6, 32); }

}

function drawRampsAndObstacles(){ // draw some ramps procedurally for track ctx.fillStyle='#8b5a2b'; for(let i=0;i<8;i++){ const rx = (i600 - (state.x%600)); const rampW = 120; const rampH = 60 * (1 + 0.2Math.sin(i)); ctx.beginPath(); ctx.moveTo(rx + 200, 430); ctx.lineTo(rx + 200 + rampW, 430 - rampH); ctx.lineTo(rx + 200 + rampW, 430); ctx.closePath(); ctx.fill(); } // obstacles ctx.fillStyle='#444'; for(let i=0;i<20;i++){ const ox = (i320 - (state.x0.7)%320); ctx.fillRect(ox+20, 430-18, 16, 18); } }

function drawGhost(gS){ // draw ghost semi-transparent drawBike(ctx, W*0.4 - 60, gS.y, -gS.angle, state.bike, {}); ctx.globalAlpha = 1; }

function drawBike(ctx, x, y, angle, bike, extra){ ctx.save(); ctx.translate(x,y); ctx.rotate(angle); // shadow ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.beginPath(); ctx.ellipse(0, 32, 84, 20, 0,0,Math.PI2); ctx.fill(); const wb = bike.wheelBase || 140; // rear wheel ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(-wb/2, 0, bike.rearR, 0, Math.PI2); ctx.fill(); ctx.fillStyle='#666'; ctx.beginPath(); ctx.arc(-wb/2, 0, bike.rearR-8, 0, Math.PI2); ctx.fill(); // front ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(wb/2, 0, bike.frontR, 0, Math.PI2); ctx.fill(); ctx.fillStyle='#666'; ctx.beginPath(); ctx.arc(wb/2, 0, bike.frontR-8, 0, Math.PI2); ctx.fill(); // frame ctx.fillStyle = bike.color || '#ffcc00'; ctx.beginPath(); ctx.moveTo(-wb/2+10,-6); ctx.quadraticCurveTo(-6,-26,6,-32); ctx.quadraticCurveTo(wb/2-18,-26,wb/2-8,-8); ctx.lineTo(wb/2-8,6); ctx.quadraticCurveTo(0,-2,-wb/2+10,6); ctx.closePath(); ctx.fill(); // seat ctx.fillStyle='#222'; ctx.fillRect(-6,-28,34,7); // headlight ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(wb/2+26,-26,10,8,0,0,Math.PI2); ctx.fill(); ctx.fillStyle='#ffd'; ctx.beginPath(); ctx.ellipse(wb/2+28,-26,6,4,0,0,Math.PI2); ctx.fill(); // rider ctx.fillStyle='#3a6'; ctx.beginPath(); ctx.arc(-8,-44,10,0,Math.PI2); ctx.fill(); ctx.fillStyle='#2b2'; ctx.fillRect(-18,-34,14,18); // small smoke if braking if(input.brake){ ctx.globalAlpha = 0.6; for(let i=0;i<4;i++){ ctx.beginPath(); ctx.fillStyle='rgba(120,120,120,0.6)'; ctx.arc(-wb/2 + Math.random()*20, -6 - Math.random()*6, 6+Math.random()6,0,Math.PI2); ctx.fill(); } ctx.globalAlpha = 1; } ctx.restore(); }

// Shop UI (simple modal) function openShop(){ const modal = document.createElement('div'); modal.style.position='fixed'; modal.style.left='50%'; modal.style.top='50%'; modal.style.transform='translate(-50%,-50%)'; modal.style.background='#fff'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.boxShadow='0 18px 46px rgba(0,0,0,0.4)'; modal.innerHTML = <h3>Päivitykset</h3><div>Kolikot: ${state.shop.coins}</div>; const items = [{id:'torque',name:'Moottoripäivitys',cost:50},{id:'susp',name:'Jousitus',cost:40},{id:'grip',name:'Renkaat',cost:30}]; items.forEach(it=>{ const b = document.createElement('button'); b.textContent = it.name + ' ('+it.cost+')'; b.style.margin='8px'; b.onclick = ()=>{ if(state.shop.coins >= it.cost){ state.shop.coins -= it.cost; state.shop.upgrades[it.id] = (state.shop.upgrades[it.id]||0)+1; toast('Ostit: '+it.name); saveState(); } else toast('Ei tarpeeksi kolikoita'); }; modal.appendChild(b);} ); const close = document.createElement('button'); close.textContent='Sulje'; close.style.margin='8px'; close.onclick=()=>modal.remove(); modal.appendChild(close); document.body.appendChild(modal); }

// Gamepad function pollGamepad(){ const pads = navigator.getGamepads ? navigator.getGamepads() : []; if(!pads) return; const p = pads[0]; if(!p) return; input.gas = p.buttons[7] && p.buttons[7].pressed; input.brake = p.buttons[6] && p.buttons[6].pressed; input.left = p.axes[0] < -0.5; input.right = p.axes[0] > 0.5; }

// Main loop let last = performance.now(); function loop(now){ const dt = Math.min(0.05, (now-last)/1000); last = now; if(!state.paused){ pollGamepad(); step(dt); } draw(); requestAnimationFrame(loop); } requestAnimationFrame(loop);

// Accessibility / info function init(){ // resume audio on user gesture if needed document.body.addEventListener('pointerdown', ()=>{ if(audio && audio.state === 'suspended') audio.resume(); }, {once:true}); toast('Tervetuloa! Paina A = kaasu, S = jarru, välilyönti nitro (jos saatavilla).'); } init();

})(); </script>

</body>
</html>
